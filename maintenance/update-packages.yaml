- name: Update and upgrade apt packages
  hosts: all

  become: true

  tasks:
    - name: Update packages with apt
      apt:
        upgrade: yes
        update_cache: yes
      register: apt_update_result


    - name: Check if a reboot is required.
      ansible.builtin.stat:
        path: /var/run/reboot-required
        get_checksum: no
      register: reboot_required_file

    - name: Construct list of updated packages
      set_fact:
        updated_packages_list: "{{ apt_update_result | json_query('package_updates[*].name') }}"
    
    - name: Send update information to Telegram
      community.general.telegram:
        token: "{{ lookup('env', 'BOT_TOKEN') }}"
        api_args:
          chat_id: "{{ lookup('env', 'CHAT_ID') }}"
          parse_mode: "markdown"
          text: |
            "({{ ansible_hostname }} @ {{ inventory_hostname }})Packages have been Updated, Reboot {{ 'required' if reboot_required_file.stat.exists else 'NOT required' }}.\n\n
            Number of updated packages: {{ updated_packages_list | length }}\n\n
            List of updated packages:\n
            {% for package in updated_packages_list %}
              - {{ package }}
            {% endfor %}"


    - name: Remove dependencies that are no longer required.
      ansible.builtin.apt:
        autoremove: yes